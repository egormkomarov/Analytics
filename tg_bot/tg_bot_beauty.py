import pandas as pd
import os
import numpy as np

import json
from sqlalchemy import create_engine

import logging
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
from telegram.ext.filters import TEXT, PHOTO


def connection_db():
    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ JSON
    with open('credentials.json') as file:
        credentials = json.load(file)

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    db_username = credentials['username']
    db_password = credentials['password']
    db_host = 'localhost'  # –ò–ª–∏ –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db_name = 'postgres'  # –ò–º—è –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db_port = '5432'  # –ü–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    connection_string = f'postgresql://{db_username}:{db_password}@{db_host}:{db_port}/{db_name}'

    # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ Engine –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    eng = create_engine(connection_string)

    return eng


engine = connection_db()


def tg_token():
    # –¢–æ–∫–µ–Ω –¢–ì
    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ JSON
    with open('token_tg.json') as file:
        token_json = json.load(file)
    token = token_json['token']

    return token


TELEGRAM_BOT_TOKEN = tg_token()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)


def start(update: Update, context: CallbackContext):
    welcome_message = (
        """–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç "–°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã –ö–∏–ø—Ä–∞" ‚Äî —Ç–≤–æ–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –ø–æ–∏—Å–∫–µ –∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Å–ª—É–≥–∏ –∫—Ä–∞—Å–æ—Ç—ã –Ω–∞ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–º –æ—Å—Ç—Ä–æ–≤–µ –ö–∏–ø—Ä!

    üå∏ –ß—Ç–æ —è –º–æ–≥—É –¥–ª—è —Ç–µ–±—è —Å–¥–µ–ª–∞—Ç—å?
    
        –Ø —Å–æ–±—Ä–∞–ª –¥–ª—è —Ç–µ–±—è –≤—Å–µ —Å–∞–º—ã–µ –ª—É—á—à–∏–µ —Å–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã —Å–æ –≤—Å–µ–≥–æ –ö–∏–ø—Ä–∞, —á—Ç–æ–±—ã —Ç—ã –º–æ–≥ –Ω–∞–π—Ç–∏ –∏ –≤—ã–±—Ä–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ —Ç–µ–±–µ.
        –Ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é —Ç–µ–±–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø–∏—Å–∏ –Ω–∞ –ª—é–±—É—é —É—Å–ª—É–≥—É –∫—Ä–∞—Å–æ—Ç—ã –≤ –ª—é–±–æ–º –≥–æ—Ä–æ–¥–µ –ö–∏–ø—Ä–∞.
         –£ –Ω–∞—Å –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–∞–ª–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —É—Å–ª—É–≥, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —É—Ö–æ–¥ –∏ —Å—Ç–∏–ª—å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
         
        üíÖ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º?
        
        1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—É—é —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä, –º–∞–Ω–∏–∫—é—Ä, –ø–µ–¥–∏–∫—é—Ä, –º–∞—Å—Å–∞–∂ –∏–ª–∏ –ª—é–±—É—é –¥—Ä—É–≥—É—é —É—Å–ª—É–≥—É, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–±–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞, –≤–∫–ª—é—á–∞—è –º—É–∂—Å–∫–∏–µ —É—Å–ª—É–≥–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ –±—Ä–∏—Ç—å–µ, —Å—Ç—Ä–∏–∂–∫–∞ –∏ –ø–æ–¥—Å—Ç—Ä–∏–≥–∞–Ω–∏–µ –±–æ—Ä–æ–¥—ã.
        2Ô∏è‚É£ –£–∫–∞–∂–∏ –≥–æ—Ä–æ–¥, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Ö–æ—Ç–µ–ª –±—ã –ø–æ–ª—É—á–∏—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É. –ù–∞–ø—Ä–∏–º–µ—Ä, –õ–∏–º–∞—Å—Å–æ–ª, –ü–∞—Ñ–æ—Å, –õ–∞—Ä–Ω–∞–∫–∞ –∏ —Ç.–¥.
        3Ô∏è‚É£ –Ø –ø—Ä–µ–¥–ª–æ–∂—É —Ç–µ–±–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∞–ª–æ–Ω–æ–≤ –∫—Ä–∞—Å–æ—Ç—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ, –≥–¥–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω—É–∂–Ω—É—é —É—Å–ª—É–≥—É. –¢—ã —Å–º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å —Å–∞–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —É—Å–ª—É–≥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        4Ô∏è‚É£ –í—ã–±–µ—Ä–∏ —É–¥–æ–±–Ω–æ–µ –¥–ª—è —Ç–µ–±—è –≤—Ä–µ–º—è –∏ –∑–∞–ø–∏—à–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —á—Ç–æ–±—ã —Ç—ã –º–æ–≥ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —É—Ö–æ–¥–æ–º –∏ —Å—Ç–∏–ª—å–Ω—ã–º –ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.
    
        üåü –ü–æ–ª—å–∑—É–π—Å—è –º–æ–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è –∫—Ä–∞—Å–æ—Ç–æ–π –∏ —É—Ö–æ–¥–æ–º –∑–∞ —Å–æ–±–æ–π –Ω–∞ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–º –æ—Å—Ç—Ä–æ–≤–µ –ö–∏–ø—Ä! –ï—Å–ª–∏ —É —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ, –∏ —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É —Ç–µ–±–µ.
        
        –î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Å–ª—É–≥—É –≤—ã–±–µ—Ä–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —Å–∞–ª–æ–Ω, –º–∞—Å—Ç–µ—Ä–∞, –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, –∏ —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–¥–µ–ª–∞—Ç—å –±—Ä–æ–Ω—å. –ë—É–¥—å –≤ –∫—É—Ä—Å–µ –∞–∫—Ü–∏–π –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–∞–ª–æ–Ω–∞—Ö –∫—Ä–∞—Å–æ—Ç—ã –Ω–∞ –ö–∏–ø—Ä–µ.
            
        ‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –∫—Ä–∞—Å–æ—Ç—ã –∏ —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏ –Ω–∞ –ö–∏–ø—Ä–µ, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ö–æ–¥ –∏ —Å—Ç–∏–ª—å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω–∏–µ!
        
        –û—Ç–ø—Ä–∞–≤—å /help, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö –∏ —Ñ—É–Ω–∫—Ü–∏—è—Ö.
        """
    )

    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–º–æ—â–∏
    help_button = InlineKeyboardButton("–ü–æ–º–æ—â—å", callback_data="help")
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥
    services_button = InlineKeyboardButton("–£—Å–ª—É–≥–∏", callback_data="services")

    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    keyboard = [
        [help_button, services_button]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    # return context.bot.send_message(chat_id=Update.effective_chat.id, text=welcome_message, reply_markup=reply_markup)
    return update.message.reply_text(text=welcome_message, reply_markup=reply_markup)


def main():
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(CommandHandler("start", start))

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    application.run_polling()


if __name__ == '__main__':
    main()
